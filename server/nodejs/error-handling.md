# 오류 처리

## 오류의 종류

### 기술적 오류

Database 서버가 다운되는 등의 기술적 오류가 발생하면 할 수 있는 게 별로 없습니다.\
사용자에게 오류 페이지를 통해 서버 측에 문제가 생겼다고 알리고 문제를 해결하고 있다는 느낌을 전하는 것이 최선입니다.

### 예견된 오류

한 파일에 동시에 너무 많은 요청이 있거나, 사용가자 유효하지 않은 데이터를 입력하는 예견된 오류의 경우 사용자에게 다시 시도해 보라고 알리는 것이 좋습니다.

### 논리적 오류

코드에 생길 수 있는 오류로 사용자에게 오류 메시지가 나타나지 않아야 합니다.
이런 오류는 개발 중에 테스트를 거텨 수정해야 하지, 앱 가동 중에 처리하지 않아야 합니다.

## 오류 처리 방법

리다이렉트하거나, 입력값은 모두 유지하면서 오류 메시지만 추가하여 사용자가 있던 페이지를 반환하면서 오류 정보를 줄 수 있습니다.\
사용자에게 문제가 있음을 알리는 오류 페이지를 반환하는 건 사용자가 모든 입력값을 잃고 이어갈 수 없기 때문에 최후의 수단으로 사용해야 합니다.

### 오류를 나타내는 경우(Error is thrown)

코드를 테스트해서 오류를 잡아낼 수 있는 특정 툴을 사용해서 오류를 처리합니다.\
동기식(Syncronous) 코드인 경우 `try-catch` 블록을 사용합니다.\
Promise가 있는 비동기식 코드의 경우 `then` 및 `catch` 블록을 사용합니다.

두 경우 모두 오류를 직접 처리할지 Express에 내장된 오류 처리 미들웨어 메커니즘을 사용할지 정해야 합니다.

#### Error is thrown 예시

```tsx
setInterval(() => {
  console.log('시작');
  try {
    throw new Error('서버를 고장내주마!');
  } catch (err) {
    console.error(err);
  }
}, 1000);
```

에러가 발생했을 때 에러를 `throw`했습니다.\
`throw`하면 노드 프로세스가 멈춰버립니다.\
따라서 throw하는 경우에는 반드시 `try/catch`문으로 `throw`한 에러를 잡아야 합니다.

### 오류를 나타내지 않는 경우(No error is thrown)

`if` 검사를 통해 값을 확인해서 오류로 나타낼지 정해야 합니다.\
오류를 나타내도록 결정하면 오류 처리 과정을 진행합니다.\
"오류"를 직접 처리하고자 한다면 빠진 입력 데이터로 계속할 수 있는 코드를 추가하여 데이터를 그대로 이어갈 수 있는지 확인합니다.

#### No error is thrown 예시

```tsx
const fs = require('fs');

setInterval(() => {
  fs.unlink('./abcdefg.js', (err) => {
    if (err) {
      console.error(err);
    }
  });
}, 1000);
```

에러가 발생하지만, 노드 내장 모듈의 에러는 실행 중인 프로세스를 멈추지 않습니다.\
에러 로그를 기록해두고 나중에 원인을 찾아 수정하면 됩니다.

## Express.js 오류 처리 미들웨어

### 미들웨어 next()

`next()`를 하면 다음 미들웨어로 넘어갑니다.\
`next(인수)`를 하면 에러 핸들러로 넘어갑니다.\
`next('route')`를 하면 다음 라우터로 넘어갑니다.

## 3.8.1 자주 발생하는 에러들

- `node`\
: command not found: 노드를 설치했지만 이 에러가 발생하는 경우는 환경 변수가 제대로 설정되어 있지 않은 것입니다.\
환경 변수에는 노드가 설치된 경로가 포함되어야 합니다.\
node 외의 다른 명령어도 마찬가지입니다.\
그 명령어를 수행할 수 있는 파일이 환경 변수에 들어 있어야 명령어를 콘솔에서 사용할 수 있습니다.

- `ReferenceError`\
: 모듈 is not defined: 모듈을 require했는지 확인합니다.

- `Error: Cannot find module 모듈명`\
: 해당 모듈을 require했지만 설치하지 않았습니다. npm i 명령어로 설치하세요.

- `Error [ERR_MODULE_NOT_FOUND]`\
: 존재하지 않는 모듈을 불러오려 할 때 발생합니다.

- `Error: Can't set headers after they are sent`\
: 요청에 대한 응답을 보낼 때 응답을 두 번 이상 보냈습니다. 요청에 대한 응답은 한 번만 보내야 합니다. 응답을 보내는 메서드를 두 번 이상 사용하지 않았는지 체크해보세요.

- `FATAL ERROR: CALL_AND_RETRY_LAST Allocation failed- JavaScript heap out of memory`\
: 코드를 실행할 때 메모리가 부족해서 스크립트가 정상적으로 작동하지 않는 경우입니다.\
코드가 잘못 구현되었을 확률이 높으므로 코드를 점검해보세요.\
만약 코드는 정상이지만 노드가 활용할 수 있는 메모리가 부족한 경우라면 노드의 메모리를 늘릴 수 있습니다.\
노드를 실행할 때 `node --max-old-space-size=4096` 파일명과 같은 명령어를 사용하면 됩니다.\
4096은 4GB를 의미합니다.\
여기에 원하는 용량을 적으면 됩니다.

- `UnhandledPromiseRejectionWarning: Unhandled promise rejection`\
: 프로미스 사용 시 catch 메서드를 붙이지 않으면 발생합니다.\
항상 catch를 붙여 에러가 발생하는 상황에 대비하세요.

- `EADDRINUSE 포트 번호`
: 해당 포트 번호에 이미 다른 프로세스가 연결되어 있습니다.\
그 프로세스는 노드 프로세스일 수도 있고 다른 프로그램일 수도 있습니다.\
그 프로세스를 종료하거나 다른 포트 번호를 사용해야 합니다.

- `EACCES 또는 EPERM`\
: 노드가 작업을 수행하는 데 권한이 충분하지 않습니다.\
파일/폴더 수정, 삭제, 생성 권한을 확인해보는 것이 좋습니다.\
맥이나 리눅스 운영체제라면 명령어 앞에 sudo를 붙이는 것도 방법입니다.

- `EJSONPARSE`\
: package.json 등의 JSON 파일에 문법 오류가 있을 때 발생합니다.\
자바스크립트 객체와는 형식이 조금 다르니 쉼표 같은 게 빠지거나 추가되지는 않았는지 확인해보세요.

- `ECONNREFUSED`
: 요청을 보냈으나 연결이 성립하지 않을 때 발생합니다.\
요청을 받는 서버의 주소가 올바른지, 서버가 꺼져 있지는 않은지 등을 확인해봐야 합니다.

- `ETARGET`\
: package.json에 기록한 패키지 버전이 존재하지 않을 때 발생합니다.\
해당 버전이 존재하는지 확인하세요.

- `ETIMEOUT`
: 요청을 보냈으나 응답이 시간 내에 오지 않을 때 발생합니다.\
역시 요청을 받는 서버의 상태를 점검해봐야 합니다.

- `ENOENT: no such file or directory`\
: 지정한 폴더나 파일이 존재하지 않는 경우입니다.\
맥이나 리눅스 운영체제에서는 대소문자도 구별하므로 확인해봐야 합니다.

## 참고 자료

[NodeJS - The Complete Guide (MVC, REST APIs, GraphQL, Deno)](https://www.udemy.com/course/nodejs-the-complete-guide/?couponCode=ST21MT61124)
[[EXPRESS] 📚 미들웨어 이론 & 실용 💯 정리
출처: https://inpa.tistory.com/entry/EXPRESS-📚-미들웨어-💯-이해-정리 [Inpa Dev 👨‍💻:티스토리]](https://inpa.tistory.com/entry/EXPRESS-%F0%9F%93%9A-%EB%AF%B8%EB%93%A4%EC%9B%A8%EC%96%B4-%F0%9F%92%AF-%EC%9D%B4%ED%95%B4-%EC%A0%95%EB%A6%AC)
